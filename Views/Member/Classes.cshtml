@model TTFWebsite.Models.ClassesViewModel
@{
    ViewData["Title"] = "Aulas - √Årea de Membros";
    ViewData["BodyClass"] = "classes-bg";
    Layout = "~/Views/Shared/_MemberLayout.cshtml";
}

<div class="classes-container">

    <div id="global-booking-messages">
        <div id="booking-success-message" class="booking-message success"></div>
        <div id="booking-error-message" class="booking-message error"></div>
    </div>

    <div class="classes-header">
        <h1>Aulas e Reservas</h1>
        <p>Reserva as tuas aulas favoritas</p>
    </div>

    @if (Model.UserReservations.Any())
    {
        <div class="section">
            <h2>As Minhas Reservas</h2>
            <div class="reservations-grid" id="reservationsGrid">
                @foreach (var reservation in Model.UserReservations)
                {
                    var date = reservation.DataAula.ToString("dd MMM", new System.Globalization.CultureInfo("pt-PT"));
                    var startTime = reservation.HoraInicio;
                    var endTime = reservation.HoraFim;
                    var startAttr = reservation.DataAula.Add(reservation.HoraInicio).ToString("o");
                    var timeRange = $"{startTime:hh\\:mm} - {endTime:hh\\:mm}";

                    <div class="class-card reserved"
                         data-id="@reservation.idAulaMarcada"
                         data-start="@startAttr">

                        <div class="class-body small">
                            <h3>@reservation.nomeAula</h3>
                            <div class="class-details">
                                <div><span class="detail-icon">üïú</span> @($"{date} {timeRange}")</div>
                                <div><span class="detail-icon">üë§</span> @reservation.instrutor</div>
                                <div><span class="detail-icon">üìç</span> Sala @reservation.sala</div>
                            </div>
                        </div>

                        <div class="class-footer">
                            <button class="btn-cancel"
                                    onclick="openCancelModal(@reservation.idAulaMarcada)">
                                Cancelar
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="section section-available">
        <h2>Aulas Dispon√≠veis</h2>

        <div class="classes-filters">
            <button class="filter-btn active" onclick="filterClasses('all', this)">Todas</button>
            <button class="filter-btn" onclick="filterClasses('today', this)">Hoje</button>
            <button class="filter-btn" onclick="filterClasses('week', this)">Esta Semana</button>
        </div>

        <div class="carousel-wrap">
            <button class="carousel-arrow prev">‚Äπ</button>
            <div class="classes-grid horizontal-carousel" id="classesCarousel">
                @foreach (var classItem in Model.AvailableClasses.OrderBy(c => c.DataAula + c.HoraInicio))
                {
                    var startTime = classItem.DataAula + classItem.HoraInicio;
                    var date = classItem.DataAula.ToString("dd MMM", new System.Globalization.CultureInfo("pt-PT"));
                    var timeRange = $"{classItem.HoraInicio:hh\\:mm} - {classItem.HoraFim:hh\\:mm}";

                    var isBooked = Model.UserReservations.Any(r => r.idAulaMarcada == classItem.IdAulaMarcada);
                    var isFull = classItem.ReservasAtuais >= classItem.Capacidade;
                    var isPast = startTime < DateTime.Now;

                    <div class="class-card @(isPast ? "past" : "") @(isBooked ? "reserved" : "")"
                         data-id="@classItem.IdAulaMarcada"
                         data-start="@startTime.ToString("o")"
                         data-capacity="@classItem.Capacidade"
                         data-current="@classItem.ReservasAtuais">

                        <div class="class-header">
                            <h3 class="card-title">@classItem.Nome</h3>
                            <div class="class-date-time">@timeRange</div>
                        </div>

                        <div class="class-body small">
                            <div class="class-details">
                                <div class="instructor"><span class="detail-icon">üë§</span> @classItem.NomeInstrutor</div>
                                <div class="room"><span class="detail-icon">üìç</span> Sala @classItem.Sala</div>
                                <div class="reservas-contador">
                                    <span class="detail-icon">üë•</span> Capacidade: @classItem.ReservasAtuais/@classItem.Capacidade
                                </div>
                            </div>
                        </div>

                        <div class="class-footer">
                            @if (isPast)
                            {
                                <button class="btn-disabled" disabled>Aula j√° decorreu</button>
                            }
                            else if (isBooked)
                            {
                                <button class="btn-booked" disabled>J√° reservada</button>
                            }
                            else if (isFull)
                            {
                                <button class="btn-full" disabled>Lotada</button>
                            }
                            else
                            {
                                <button class="btn-book" onclick="openClassBookingModal(@classItem.IdAulaMarcada)">
                                    Reservar
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
            <button class="carousel-arrow next">‚Ä∫</button>
        </div>
    </div>
</div>

<div id="cancel-reservation-modal" class="booking-modal" inert>
    <div class="booking-dialog" role="dialog" aria-modal="true" aria-labelledby="cancelTitle">
        <button class="close-btn" aria-label="Fechar" onclick="closeCancelModal()">√ó</button>
        <h3 id="cancelTitle">Cancelar Reserva</h3>
        <p id="cancelModalMessage">Tens a certeza que queres cancelar a reserva desta aula?</p>

        <div class="dialog-actions">
            <button class="btn btn-primary" onclick="confirmCancelReservation()">Sim, cancelar</button>
            <button class="btn btn-secondary" onclick="closeCancelModal()">N√£o</button>
        </div>
    </div>
</div>

<div id="class-booking-modal" class="booking-modal" inert>
    <div class="booking-dialog" role="dialog" aria-modal="true" aria-labelledby="bookTitle">
        <button class="close-btn" aria-label="Fechar" onclick="closeClassBookingModal()">√ó</button>
        <h3 id="bookTitle">Reservar Aula</h3>
        <p>Queres reservar esta aula?</p>
        <div class="dialog-actions">
            <button class="btn btn-primary" onclick="confirmBookClass()">Sim, reservar</button>
            <button class="btn btn-secondary" onclick="closeClassBookingModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const successEl = document.getElementById('booking-success-message');
    const errorEl   = document.getElementById('booking-error-message');
    const modal     = document.getElementById('class-booking-modal');
    const cancelModal = document.getElementById('cancel-reservation-modal');

    let pendingClassId = null;
    let pendingCancel = null;

    function clearMessageElements(){
        [successEl, errorEl].forEach(el=>{
            if (!el) return;
            el.classList.remove('show');
            el.style.display = 'none';
            el.innerText = '';
        });
    }

    function showBookingMessage(msg, type){
        const el = type==='success'? successEl : errorEl;
        const otherEl = type==='success'? errorEl : successEl;
        if(!el) return;
        if(otherEl){ otherEl.classList.remove('show'); otherEl.style.display='none'; otherEl.innerText=''; }
        el.innerText = msg;
        el.style.display = 'block';
        void el.offsetWidth;
        el.classList.add('show');
        setTimeout(()=>{
            el.classList.remove('show');
            setTimeout(()=>el.style.display='none',300);
        },3500);
    }

    function showBookingSuccess(msg){ showBookingMessage(msg,'success'); }
    function showBookingError(msg){ showBookingMessage(msg,'error'); }

    function openClassBookingModal(id){
        clearMessageElements();
        pendingClassId = id;
        modal.classList.add('open');
        modal.removeAttribute('inert');
    }

    function closeClassBookingModal(){
        modal.classList.remove('open');
        modal.setAttribute('inert','');
        pendingClassId = null;
    }

    function openCancelModal(classId){
        clearMessageElements();
        pendingCancel = classId;
        cancelModal.classList.add('open');
        cancelModal.removeAttribute('inert');
    }

    function closeCancelModal(){
        pendingCancel = null;
        cancelModal.classList.remove('open');
        cancelModal.setAttribute('inert','');
    }

    function getCarouselReservedIds(){
        return Array.from(document.querySelectorAll('#classesCarousel .class-card.reserved'))
            .map(c => parseInt(c.dataset.id, 10))
            .filter(n => !isNaN(n));
    }

    function computeReservedIdsFromGrid(gridEl){
        return Array.from((gridEl || document.getElementById('reservationsGrid')).querySelectorAll('.class-card'))
            .map(c => parseInt(c.dataset.id, 10))
            .filter(n => !isNaN(n));
    }

    function replaceReservationsGridFromHtml(html){
        const temp = document.createElement('div');
        temp.innerHTML = html.trim();
        let newGrid = temp.querySelector('#reservationsGrid');
        if(!newGrid){
            newGrid = document.createElement('div');
            newGrid.className = 'reservations-grid';
            newGrid.id = 'reservationsGrid';
            newGrid.innerHTML = temp.innerHTML;
        }
            const oldGrid = document.getElementById('reservationsGrid');
    let section = null;

    if(oldGrid){
        section = oldGrid.closest('.section');
        oldGrid.replaceWith(newGrid);
    }

    if(section){
        const hasCards = newGrid.querySelector('.class-card');
        section.style.display = hasCards ? '' : 'none';
    }
    return newGrid;


    }

    // Atualiza bot√µes e contador no carousel com base nas reservas atuais (array pode conter ids duplicados)
    function refreshCarouselButtons(reservedIds){
        document.querySelectorAll('#classesCarousel .class-card').forEach(card=>{
        const id = parseInt(card.dataset.id,10);
        const footer = card.querySelector('.class-footer');

        const start = new Date(card.dataset.start);
        const isPast = start < new Date();

        const capacity = parseInt(card.dataset.capacity,10);
        let current = parseInt(card.dataset.current,10);

        const wasReserved = card.classList.contains('reserved');
        const isReservedNow = reservedIds.includes(id);

        // atualizar contador apenas se houve mudan√ßa real
        if(!wasReserved && isReservedNow) current++;
        if(wasReserved && !isReservedNow) current--;

        // prote√ß√£o contra valores inv√°lidos
        current = Math.max(0, Math.min(current, capacity));
        card.dataset.current = current;


        card.dataset.current = current;

        const counterEl = card.querySelector('.reservas-contador');
        if(counterEl) counterEl.textContent = `üë• Capacidade: ${current}/${capacity}`;

        if(isPast){
            footer.innerHTML = '<button class="btn-disabled" disabled>Aula j√° decorreu</button>';
            return;
        }

        if(isReservedNow){
            card.classList.add('reserved');
            footer.innerHTML = '<button class="btn-booked" disabled>J√° reservada</button>';
            return;
        }

        if(current >= capacity){
            card.classList.remove('reserved');
            footer.innerHTML = '<button class="btn-full" disabled>Lotada</button>';
            return;
        }

        card.classList.remove('reserved');
        footer.innerHTML = `<button class="btn-book" onclick="openClassBookingModal(${id})">Reservar</button>`;
        });
        }

        async function confirmBookClass() {
        if (!pendingClassId) return showBookingError("ID da aula inv√°lido.");

        try {
            const res = await fetch(`@Url.Action("BookClass", "Member")?id=${pendingClassId}`, {
                method: 'POST',
                credentials: 'include'
            });

            const contentType = res.headers.get("content-type");
            const body = await res.text();

            if (!res.ok) {
                if (contentType && contentType.includes("application/json")) {
                    const error = JSON.parse(body);
                    return showBookingError(error.message ?? "Erro ao reservar.");
                }
                return showBookingError(body || "Erro ao reservar.");
            }

            const newGrid = replaceReservationsGridFromHtml(body);
            const newReservedIds = computeReservedIdsFromGrid(newGrid);
            refreshCarouselButtons(newReservedIds);

            showBookingSuccess("Reserva efetuada com sucesso.");
            closeClassBookingModal();
        } catch (err) {
            console.error(err);
            showBookingError("Erro inesperado ao reservar.");
        }
    }


    async function confirmCancelReservation() {
        if (!pendingCancel) return showBookingError("Reserva inv√°lida.");
        const classId = pendingCancel;

        try {
            const res = await fetch(`@Url.Action("CancelReservation", "Member")?classId=${classId}`, {
                method: 'PATCH',
                credentials: 'include'
            });

            const contentType = res.headers.get("content-type");
            const body = await res.text(); 
            if (!res.ok) {
                if (contentType && contentType.includes("application/json")) {
                    const error = JSON.parse(body);
                    return showBookingError(error.message ?? "Erro ao cancelar.");
                }
                return showBookingError(body || "Erro ao cancelar.");
            }

            const newGrid = replaceReservationsGridFromHtml(body);
            const newReservedIds = computeReservedIdsFromGrid(newGrid);
            refreshCarouselButtons(newReservedIds);

            closeCancelModal();
            showBookingSuccess("Reserva cancelada.");
        } catch (err) {
            console.error(err);
            showBookingError("Erro inesperado ao cancelar.");
        }
    }

    document.querySelector('.carousel-arrow.prev').addEventListener('click',()=>document.getElementById('classesCarousel').scrollBy({left:-360,behavior:'smooth'}));
    document.querySelector('.carousel-arrow.next').addEventListener('click',()=>document.getElementById('classesCarousel').scrollBy({left:360,behavior:'smooth'}));

    function filterClasses(filter, btn){
        document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');

        const now = new Date();
        const cards = document.querySelectorAll('#classesCarousel .class-card');

        cards.forEach(card=>{
            const start = new Date(card.dataset.start);
            let show=false;
            if(filter==='all') show=true;
            else if(filter==='today') show=start.toDateString()===now.toDateString();
            else if(filter==='week'){
                const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate()-now.getDay());
                const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+7);
                show=start>=startOfWeek && start<=endOfWeek;
            }
            card.style.display = show?'flex':'none';
        });
    }

    clearMessageElements();
</script>

<style>

    .classes-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .carousel-wrap {
        position: relative;
        display: flex;
        align-items: center;
    }

    .carousel-arrow {
        background: rgba(0,0,0,0.45);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        flex-shrink: 0;
    }

    .carousel-arrow.prev {
        position: absolute;
        left: -52px;
        z-index: 1;
    }

    .carousel-arrow.next {
        position: absolute;
        right: -52px;
        z-index: 1;
    }

    .carousel-arrow:hover {
        background: rgba(0,0,0,0.6);
    }


    .section-available h2 {
        margin-bottom: 1.25rem;
    }

    .classes-filters {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.25rem;
        margin-top: 0.5rem;
        align-items: center;
    }

    .filter-btn {
        padding: 0.45rem 0.7rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        cursor: pointer;
    }

    .filter-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: transparent;
    }

    .classes-grid.horizontal-carousel {
        display: flex;
        gap: 1rem;
        overflow-x: scroll; 
        scrollbar-width: none; 
        -ms-overflow-style: none;
        margin-left: 0;
        margin-right: 52px; 
    }

    .classes-grid.horizontal-carousel::-webkit-scrollbar {
        display: none;
    }

    .classes-grid.horizontal-carousel::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.08);
        border-radius: 999px;
    }

    .classes-grid.horizontal-carousel .class-card {
        display: flex;
        flex-direction: column;
        min-width: 340px;
        flex: 0 0 340px;
        min-height: 420px;
        box-sizing: border-box;
    }

    .class-card {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 420px;
    }

    .class-body.small {
        padding: 0.6rem 1rem 0.4rem 1rem;
        gap: 0.35rem;
    }

    .class-body.small h3 {
        font-size: 1.05rem;
        margin-bottom: 0.15rem;
    }

    .class-body.small .class-details {
        margin-top: 0;
        font-size: 0.95rem;
        line-height: 1.25;
    }

    .class-header {
        padding: .75rem 1rem;
    }

    .card-title {
        margin: 0;
        font-size: 1.15rem;
    }

    .class-body {
        padding: 1rem 1.5rem;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
    }

    .class-details {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        margin-top: 0.35rem;
    }

    .class-details .detail-icon {
        display: inline-block;
        width: 1.4em;
        text-align: center;
        margin-right: 0.1em;
    }

    #classesCarousel .class-body .class-details {
        display: flex;
        flex-direction: column;
        margin-top: 10rem;
    }

    .class-date-time {
        font-weight: 500;
    }

    .reservas-contador {
        margin-top: 4px;
    }

    .class-footer {
        padding: 0.8rem 1rem; 
        border-top: 1px solid var(--border);
        background: var(--bg-primary);
    }

    body.classes-bg .class-card,
    body.classes-bg .reservation-card {
        background: rgba(28,30,36,0.92);
    }


    .btn-book, .btn-booked, .btn-full, .btn-disabled, .btn-cancel {
        width: 100%;
        padding: .7rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        box-sizing: border-box;
    }

    .btn-book {
        background: var(--accent);
        color: white;
        cursor: pointer;
    }

    .btn-book:hover {
        background: var(--accent-hover);
    }

    .btn-booked {
        background: var(--success);
        color: white;
        cursor: not-allowed;
    }

    .btn-full, .btn-disabled {
        background: var(--bg-card);
        color: var(--text-secondary);
        cursor: not-allowed;
    }

    .class-footer .btn-cancel {
        background-color: rgb(239 68 68);
        color: #fff;
        border: none;
    }
    .class-footer .btn-cancel:hover {
        filter: brightness(0.95);
    }


    .reservations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .reservations-grid .class-card {
        min-height: auto;
    }

    .reservations-grid .class-body {
        flex: 0 0 auto;
        padding: 0.8rem 1rem 0.5rem 1rem;
    }

    .reservations-grid .class-footer {
        padding: 0.5rem 1rem 0.9rem 1rem;
        border-top: none;
        background: transparent;
    }

    .booking-message {
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        margin-bottom: 0.8rem;
        display: block;
        opacity: 0;
        transform: translateY(-8px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        font-weight: 600;
        pointer-events: auto;
        min-width: 200px;
        text-align: center;
    }

    .booking-message.success {
        background: rgba(40,167,69,0.7);
        border: 1px solid rgba(40,167,69,0.9);
        color: #fff;
    }

    .booking-message.error {
        background: rgba(220,53,69,0.7);
        border: 1px solid rgba(220,53,69,0.9);
        color: #fff;
    }

    .booking-message.show {
        opacity: 1;
        transform: translateY(0);
    }

    #global-booking-messages {
        position: fixed;
        top: 22%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: .5rem;
        pointer-events: none;
    }

    .booking-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        align-items: center;
        justify-content: center;
        z-index: 1200;
    }

        .booking-modal.open {
            display: flex;
            animation: fadeIn .12s ease both;
        }

    .booking-dialog {
        background: var(--bg-card);
        color: var(--text-primary);
        border-radius: 12px;
        padding: 1.5rem;
        min-width: 320px;
        max-width: 420px;
        box-shadow: 0 10px 40px rgba(2,6,23,.35);
        position: relative;
    }

    .dialog-actions {
        display: flex;
        gap: .5rem;
        justify-content: flex-end;
        margin-top: 1.4rem;
    }

    .btn {
        padding: .55rem .9rem;
        border-radius: 8px;
        border: 1px solid transparent;
        cursor: pointer;
        font-weight: 600;
    }

    .btn-primary {
        background: var(--accent);
        color: #fff;
    }

    .btn-secondary {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border);
    }

    .close-btn {
        position: absolute;
        right: 10px;
        top: 8px;
        background: transparent;
        border: 0;
        font-size: 1.25rem;
        cursor: pointer;
        color: var(--text-secondary);
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(6px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style> 